# æ”¶è—å’Œç‚¹èµç¼“å­˜ç­–ç•¥åˆ†æ

## ğŸ“Š ç³»ç»Ÿç¼“å­˜ç­–ç•¥æ¦‚è§ˆ

ä½ çš„ç³»ç»Ÿé‡‡ç”¨äº† **Redis + MySQL** çš„æ··åˆç¼“å­˜ç­–ç•¥ï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„æ•°æ®ä½¿ç”¨ä¸åŒçš„ç¼“å­˜æ¨¡å¼ã€‚

## ğŸ”– å•†å“æ”¶è—æ•°ç¼“å­˜ç­–ç•¥

### 1. æ•°æ®å­˜å‚¨ç»“æ„

#### MySQLå­˜å‚¨
```sql
-- goodsè¡¨
collect_num INT DEFAULT 0  -- å•†å“æ”¶è—æ•°å­—æ®µ

-- goods_favoriteè¡¨  
user_id BIGINT     -- ç”¨æˆ·ID
goods_id BIGINT    -- å•†å“ID
create_time DATETIME -- æ”¶è—æ—¶é—´
```

#### Redisç¼“å­˜ç»“æ„
```
1. ç”¨æˆ·æ”¶è—åˆ—è¡¨ ZSet
   Key: favorite:user:{userId}:ids
   Score: æ”¶è—æ—¶é—´æˆ³
   Member: å•†å“ID

2. å•†å“å¡ç‰‡ç¼“å­˜ Hash
   Key: goods:card:{goodsId}
   Field: collectNum (åŒ…å«åœ¨å•†å“å¡ç‰‡å¯¹è±¡ä¸­)
   TTL: 30åˆ†é’Ÿ + éšæœºæµ®åŠ¨
```

### 2. ç¼“å­˜æ›´æ–°ç­–ç•¥

#### æ”¶è—/å–æ¶ˆæ”¶è—æµç¨‹
```java
@Transactional
public boolean toggleFavorite(Long userId, Long goodsId) {
    // 1. æ£€æŸ¥æ”¶è—çŠ¶æ€ (æŸ¥è¯¢MySQL)
    int count = goodsMapper.checkFavorite(userId, goodsId);
    
    if (count > 0) {
        // å–æ¶ˆæ”¶è—
        goodsMapper.deleteFavorite(userId, goodsId);           // åˆ é™¤MySQLè®°å½•
        updateGoodsCollectNum(goodsId, -1);                   // æ›´æ–°å•†å“æ”¶è—æ•° (-1)
        removeFromFavoriteZSet(userId, goodsId);              // ä»Redis ZSetç§»é™¤
    } else {
        // æ·»åŠ æ”¶è—
        goodsMapper.insertFavorite(favorite);                 // æ’å…¥MySQLè®°å½•
        updateGoodsCollectNum(goodsId, 1);                    // æ›´æ–°å•†å“æ”¶è—æ•° (+1)
        addToFavoriteZSet(userId, goodsId);                   // æ·»åŠ åˆ°Redis ZSet
    }
}

private void updateGoodsCollectNum(Long goodsId, Integer flag) {
    // 1. å¢é‡æ›´æ–°MySQLä¸­çš„æ”¶è—æ•°
    goodsMapper.updateCollectNum(goodsId, flag);
    
    // 2. åˆ é™¤å•†å“å¡ç‰‡ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°ç”Ÿæˆ
    redisTemplate.delete(RedisConstant.GOODS_CARD_KEY + goodsId);
}
```

### 3. ç¼“å­˜ç‰¹ç‚¹åˆ†æ

#### âœ… ä¼˜ç‚¹
1. **æ•°æ®ä¸€è‡´æ€§å¼º** - æ¯æ¬¡æ“ä½œéƒ½åŒæ­¥æ›´æ–°MySQLå’ŒRedis
2. **æ€§èƒ½è¾ƒå¥½** - å•†å“å¡ç‰‡ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
3. **å®¹é”™æ€§å¥½** - ç¼“å­˜å¤±æ•ˆæ—¶å¯ä»MySQLæ¢å¤

#### âš ï¸ æ½œåœ¨é—®é¢˜
1. **ç¼“å­˜å¤±æ•ˆç­–ç•¥ç²—æš´** - åˆ é™¤æ•´ä¸ªå•†å“å¡ç‰‡ç¼“å­˜ï¼Œå½±å“å…¶ä»–å­—æ®µ
2. **å¹¶å‘å®‰å…¨æ€§** - é«˜å¹¶å‘ä¸‹å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´
3. **ç¼“å­˜ç©¿é€** - æ¯æ¬¡æ”¶è—æ“ä½œéƒ½ä¼šä½¿ç¼“å­˜å¤±æ•ˆ

## ğŸ’¬ è¯„è®ºç‚¹èµæ•°ç¼“å­˜ç­–ç•¥

### 1. æ•°æ®å­˜å‚¨ç»“æ„

#### MySQLå­˜å‚¨
```sql
-- commentsè¡¨
like_count INT DEFAULT 0  -- è¯„è®ºç‚¹èµæ•°å­—æ®µ
```

#### Redisç¼“å­˜ç»“æ„
```
1. è¯„è®ºç‚¹èµç”¨æˆ·é›†åˆ Set
   Key: comment:like:{commentId}
   Members: ç‚¹èµç”¨æˆ·IDåˆ—è¡¨
   TTL: 60åˆ†é’Ÿ

2. ç”¨æˆ·ç‚¹èµè¯„è®ºé›†åˆ Set  
   Key: user:like:comments:{userId}
   Members: ç”¨æˆ·ç‚¹èµçš„è¯„è®ºIDåˆ—è¡¨
   TTL: 60åˆ†é’Ÿ
```

### 2. ç¼“å­˜æ›´æ–°ç­–ç•¥

#### ç‚¹èµ/å–æ¶ˆç‚¹èµæµç¨‹
```java
@Transactional
public void likeComment(Long commentId) {
    Long currentUserId = BaseContext.getCurrentId();
    
    String commentLikeKey = RedisConstant.COMMENT_LIKE_KEY + commentId;
    String userLikeKey = RedisConstant.USER_LIKE_COMMENTS_KEY + currentUserId;
    
    // 1. æ£€æŸ¥Redisä¸­çš„ç‚¹èµçŠ¶æ€
    Boolean isMember = redisTemplate.opsForSet().isMember(commentLikeKey, currentUserId.toString());
    
    if (Boolean.TRUE.equals(isMember)) {
        // å–æ¶ˆç‚¹èµ - ä»ä¸¤ä¸ªSetä¸­ç§»é™¤
        redisTemplate.opsForSet().remove(commentLikeKey, currentUserId.toString());
        redisTemplate.opsForSet().remove(userLikeKey, commentId.toString());
    } else {
        // æ·»åŠ ç‚¹èµ - æ·»åŠ åˆ°ä¸¤ä¸ªSetä¸­
        redisTemplate.opsForSet().add(commentLikeKey, currentUserId.toString());
        redisTemplate.opsForSet().add(userLikeKey, commentId.toString());
    }
    
    // 2. è®¾ç½®è¿‡æœŸæ—¶é—´
    redisTemplate.expire(commentLikeKey, RedisConstant.COMMENT_LIKE_TTL, TimeUnit.MINUTES);
    redisTemplate.expire(userLikeKey, RedisConstant.COMMENT_LIKE_TTL, TimeUnit.MINUTES);
    
    // 3. å¼‚æ­¥æ›´æ–°MySQLç‚¹èµæ•°
    Long likeCount = redisTemplate.opsForSet().size(commentLikeKey);
    commentMapper.updateLikeCount(commentId, likeCount.intValue());
}
```

#### æŸ¥è¯¢ç‚¹èµä¿¡æ¯æµç¨‹
```java
private CommentVO buildCommentVO(Comments comment, Long currentUserId, Long sellerId) {
    String commentLikeKey = RedisConstant.COMMENT_LIKE_KEY + comment.getId();
    
    // 1. ä¼˜å…ˆä»Redisè·å–ç‚¹èµæ•°
    Long likeCount = redisTemplate.opsForSet().size(commentLikeKey);
    Boolean hasLiked = redisTemplate.opsForSet().isMember(commentLikeKey, currentUserId.toString());
    
    // 2. Redisæ— æ•°æ®æ—¶ä»MySQLè·å–
    if (likeCount == null || likeCount == 0) {
        likeCount = comment.getLikeCount() != null ? comment.getLikeCount().longValue() : 0L;
    }
    
    return CommentVO.builder()
        .likeCount(likeCount.intValue())
        .hasLiked(Boolean.TRUE.equals(hasLiked))
        .build();
}
```

### 3. ç¼“å­˜ç‰¹ç‚¹åˆ†æ

#### âœ… ä¼˜ç‚¹
1. **å®æ—¶æ€§å¼º** - Redisæ“ä½œç«‹å³ç”Ÿæ•ˆï¼Œç”¨æˆ·ä½“éªŒå¥½
2. **æ€§èƒ½ä¼˜ç§€** - ç‚¹èµæŸ¥è¯¢å®Œå…¨åŸºäºRedisï¼Œé€Ÿåº¦å¿«
3. **æ•°æ®ç»“æ„åˆç†** - ä½¿ç”¨Setå­˜å‚¨ï¼Œå¤©ç„¶å»é‡
4. **åŒå‘ç´¢å¼•** - æ”¯æŒ"è¯„è®ºçš„ç‚¹èµç”¨æˆ·"å’Œ"ç”¨æˆ·ç‚¹èµçš„è¯„è®º"åŒå‘æŸ¥è¯¢

#### âš ï¸ æ½œåœ¨é—®é¢˜
1. **æ•°æ®ä¸€è‡´æ€§é£é™©** - Rediså’ŒMySQLå¯èƒ½ä¸ä¸€è‡´
2. **ç¼“å­˜è¿‡æœŸé—®é¢˜** - 60åˆ†é’Ÿåç¼“å­˜å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ä»MySQLåŠ è½½
3. **å†…å­˜å ç”¨** - çƒ­é—¨è¯„è®ºçš„ç‚¹èµæ•°æ®å ç”¨è¾ƒå¤šå†…å­˜

## ğŸ”„ ç¼“å­˜ç­–ç•¥å¯¹æ¯”

| ç»´åº¦ | å•†å“æ”¶è—æ•° | è¯„è®ºç‚¹èµæ•° |
|------|------------|------------|
| **ä¸€è‡´æ€§** | å¼ºä¸€è‡´æ€§ (åŒæ­¥æ›´æ–°) | æœ€ç»ˆä¸€è‡´æ€§ (å¼‚æ­¥æ›´æ–°) |
| **æ€§èƒ½** | ä¸­ç­‰ (ç¼“å­˜å¤±æ•ˆå½±å“) | ä¼˜ç§€ (çº¯Redisæ“ä½œ) |
| **å®æ—¶æ€§** | å¥½ | ä¼˜ç§€ |
| **å†…å­˜ä½¿ç”¨** | ä½ (åªç¼“å­˜å•†å“å¡ç‰‡) | ä¸­ç­‰ (ç¼“å­˜ç‚¹èµå…³ç³») |
| **å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |
| **å®¹é”™æ€§** | å¥½ (MySQLå…œåº•) | ä¸­ç­‰ (ä¾èµ–ç¼“å­˜TTL) |

## ğŸš€ ä¼˜åŒ–å»ºè®®

### 1. å•†å“æ”¶è—æ•°ä¼˜åŒ–

#### é—®é¢˜ï¼šç¼“å­˜å¤±æ•ˆç­–ç•¥è¿‡äºç²—æš´
```java
// å½“å‰åšæ³•ï¼šåˆ é™¤æ•´ä¸ªå•†å“å¡ç‰‡ç¼“å­˜
redisTemplate.delete(RedisConstant.GOODS_CARD_KEY + goodsId);

// ä¼˜åŒ–å»ºè®®ï¼šåªæ›´æ–°æ”¶è—æ•°å­—æ®µ
String cardKey = RedisConstant.GOODS_CARD_KEY + goodsId;
if (redisTemplate.hasKey(cardKey)) {
    // å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°æ”¶è—æ•°å­—æ®µ
    GoodsCardVO card = (GoodsCardVO) redisTemplate.opsForValue().get(cardKey);
    if (card != null) {
        card.setCollectNum(card.getCollectNum() + flag);
        redisTemplate.opsForValue().set(cardKey, card, ttl, TimeUnit.MINUTES);
    }
}
```

#### é—®é¢˜ï¼šå¹¶å‘å®‰å…¨æ€§
```java
// ä¼˜åŒ–å»ºè®®ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”
@Transactional
public boolean toggleFavorite(Long userId, Long goodsId) {
    String lockKey = "favorite:lock:" + userId + ":" + goodsId;
    RLock lock = redissonClient.getLock(lockKey);
    
    try {
        if (lock.tryLock(3, TimeUnit.SECONDS)) {
            // æ‰§è¡Œæ”¶è—é€»è¾‘
            return doToggleFavorite(userId, goodsId);
        } else {
            throw new RuntimeException("æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

### 2. è¯„è®ºç‚¹èµæ•°ä¼˜åŒ–

#### é—®é¢˜ï¼šç¼“å­˜è¿‡æœŸåçš„å†·å¯åŠ¨
```java
// ä¼˜åŒ–å»ºè®®ï¼šé¢„çƒ­æœºåˆ¶
public void warmUpCommentLikes(Long commentId) {
    String commentLikeKey = RedisConstant.COMMENT_LIKE_KEY + commentId;
    
    if (!redisTemplate.hasKey(commentLikeKey)) {
        // ä»æ•°æ®åº“åŠ è½½ç‚¹èµå…³ç³»
        List<Long> likedUserIds = commentMapper.getLikedUserIds(commentId);
        if (!likedUserIds.isEmpty()) {
            String[] userIds = likedUserIds.stream()
                .map(String::valueOf)
                .toArray(String[]::new);
            redisTemplate.opsForSet().add(commentLikeKey, userIds);
            redisTemplate.expire(commentLikeKey, RedisConstant.COMMENT_LIKE_TTL, TimeUnit.MINUTES);
        }
    }
}
```

#### é—®é¢˜ï¼šæ•°æ®ä¸€è‡´æ€§ä¿éšœ
```java
// ä¼˜åŒ–å»ºè®®ï¼šå®šæ—¶åŒæ­¥ä»»åŠ¡
@Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
public void syncCommentLikeCounts() {
    // è·å–æ‰€æœ‰æ´»è·ƒçš„è¯„è®ºç‚¹èµç¼“å­˜
    Set<String> keys = redisTemplate.keys(RedisConstant.COMMENT_LIKE_KEY + "*");
    
    for (String key : keys) {
        Long commentId = Long.parseLong(key.replace(RedisConstant.COMMENT_LIKE_KEY, ""));
        Long redisCount = redisTemplate.opsForSet().size(key);
        
        if (redisCount != null && redisCount > 0) {
            // æ‰¹é‡æ›´æ–°æ•°æ®åº“
            commentMapper.updateLikeCount(commentId, redisCount.intValue());
        }
    }
}
```

## ğŸ“Š æ€§èƒ½ç›‘æ§å»ºè®®

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§
- **ç¼“å­˜å‘½ä¸­ç‡** - å•†å“å¡ç‰‡ç¼“å­˜å‘½ä¸­ç‡
- **æ•°æ®ä¸€è‡´æ€§** - Redisä¸MySQLæ•°æ®å·®å¼‚ç›‘æ§
- **æ“ä½œå»¶è¿Ÿ** - æ”¶è—/ç‚¹èµæ“ä½œå“åº”æ—¶é—´
- **å†…å­˜ä½¿ç”¨** - ç‚¹èµæ•°æ®å ç”¨çš„Rediså†…å­˜

### 2. å‘Šè­¦è®¾ç½®
- ç¼“å­˜å‘½ä¸­ç‡ä½äº80%æ—¶å‘Šè­¦
- æ•°æ®ä¸ä¸€è‡´è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
- æ“ä½œå»¶è¿Ÿè¶…è¿‡100msæ—¶å‘Šè­¦

ä½ çš„ç³»ç»Ÿæ•´ä½“ç¼“å­˜ç­–ç•¥è®¾è®¡åˆç†ï¼Œé’ˆå¯¹ä¸åŒåœºæ™¯é‡‡ç”¨äº†é€‚åˆçš„ç¼“å­˜æ¨¡å¼ã€‚å•†å“æ”¶è—æ•°æ³¨é‡ä¸€è‡´æ€§ï¼Œè¯„è®ºç‚¹èµæ•°æ³¨é‡æ€§èƒ½ï¼Œè¿™æ˜¯å¾ˆå¥½çš„æƒè¡¡ã€‚