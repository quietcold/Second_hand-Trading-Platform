<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xyz.mapper.GoodsMapper">

    <!-- 商品详情结果映射（处理imageUrls的JSON转换） -->
    <resultMap id="goodsDetailResultMap" type="com.xyz.vo.GoodsDetailVO">
        <id property="id" column="id"/>
        <result property="ownerId" column="ownerId"/>
        <result property="goodsType" column="goodsType"/>
        <result property="description" column="description"/>
        <result property="imageUrls" column="imageUrls" 
                typeHandler="com.xyz.handler.ListStringTypeHandler"/>
        <result property="categoryId" column="categoryId"/>
        <result property="conditionLevel" column="conditionLevel"/>
        <result property="collectNum" column="collectNum"/>
        <result property="sellPrice" column="sellPrice"/>
        <result property="rentPrice" column="rentPrice"/>
        <result property="status" column="status"/>
        <result property="createTime" column="createTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="ownerName" column="ownerName"/>
        <result property="ownerAvatar" column="ownerAvatar"/>
    </resultMap>

    <!-- 商品卡片公共字段 -->
    <sql id="goodsCardColumns">
        g.id,
        g.owner_id AS ownerId,
        g.goods_type AS goodsType,
        CASE WHEN CHAR_LENGTH(g.description) > 25 
             THEN CONCAT(SUBSTRING(g.description, 1, 25), '...') 
             ELSE g.description 
        END AS briefDescription,
        g.cover_url AS coverUrl,
        g.collect_num AS collectNum,
        g.sell_price AS sellPrice,
        g.rent_price AS rentPrice,
        UNIX_TIMESTAMP(g.update_time) * 1000 AS updateTimestamp,
        u.nickname AS ownerName,
        u.image AS ownerAvatar
    </sql>

    <!-- 根据ID查询单个商品卡片 -->
    <select id="getGoodsCardById" resultType="com.xyz.vo.GoodsCardVO">
        SELECT <include refid="goodsCardColumns"/>
        FROM goods g
        LEFT JOIN user u ON g.owner_id = u.id
        WHERE g.id = #{id}
    </select>

    <!-- 根据ID查询商品详情 -->
    <select id="getGoodsDetailById" resultMap="goodsDetailResultMap">
        SELECT g.id,
               g.owner_id AS ownerId,
               g.goods_type AS goodsType,
               g.description,
               g.image_urls AS imageUrls,
               g.category_id AS categoryId,
               g.condition_level AS conditionLevel,
               g.collect_num AS collectNum,
               g.sell_price AS sellPrice,
               g.rent_price AS rentPrice,
               g.status,
               g.create_time AS createTime,
               g.update_time AS updateTime,
               u.nickname AS ownerName,
               u.image AS ownerAvatar
        FROM goods g
        LEFT JOIN user u ON g.owner_id = u.id
        WHERE g.id = #{id}
    </select>

    <!-- 搜索商品ID（全文索引，只返回ID） -->
    <select id="searchGoodsIds" resultType="java.lang.Long">
        SELECT g.id
        FROM goods g
        WHERE g.status = 1
          AND (
            MATCH(g.description) AGAINST(#{keyword} IN NATURAL LANGUAGE MODE)
            OR g.description LIKE CONCAT('%', #{keyword}, '%')
            )
          AND UNIX_TIMESTAMP(g.update_time) * 1000 &lt; #{cursor}
        ORDER BY g.update_time DESC
        LIMIT #{size}
    </select>

    <!-- 管理员多条件查询商品（动态SQL） -->
    <select id="queryGoodsByConditions" resultType="com.xyz.vo.GoodsCardVO">
        SELECT <include refid="goodsCardColumns"/>
        FROM goods g
        LEFT JOIN user u ON g.owner_id = u.id
        <where>
            <!-- 游标分页 -->
            <if test="query.cursor != null and query.cursor > 0">
                AND UNIX_TIMESTAMP(g.update_time) * 1000 &lt; #{query.cursor}
            </if>
            
            <!-- 商品状态 -->
            <if test="query.status != null">
                AND g.status = #{query.status}
            </if>
            
            <!-- 分类ID -->
            <if test="query.categoryId != null">
                AND g.category_id = #{query.categoryId}
            </if>
            
            <!-- 发布用户ID -->
            <if test="query.ownerId != null">
                AND g.owner_id = #{query.ownerId}
            </if>
            
            <!-- 商品类型 -->
            <if test="query.goodsType != null">
                AND g.goods_type = #{query.goodsType}
            </if>
            
            <!-- 关键词搜索 -->
            <if test="query.keyword != null and query.keyword != ''">
                AND g.description LIKE CONCAT('%', #{query.keyword}, '%')
            </if>
            
            <!-- 价格范围（根据商品类型判断查询售价还是租金） -->
            <if test="query.minPrice != null">
                AND (
                    (g.goods_type = 1 AND g.sell_price >= #{query.minPrice})
                    OR (g.goods_type = 2 AND g.rent_price >= #{query.minPrice})
                    OR (g.goods_type = 3 AND (g.sell_price >= #{query.minPrice} OR g.rent_price >= #{query.minPrice}))
                )
            </if>
            <if test="query.maxPrice != null">
                AND (
                    (g.goods_type = 1 AND g.sell_price &lt;= #{query.maxPrice})
                    OR (g.goods_type = 2 AND g.rent_price &lt;= #{query.maxPrice})
                    OR (g.goods_type = 3 AND (g.sell_price &lt;= #{query.maxPrice} OR g.rent_price &lt;= #{query.maxPrice}))
                )
            </if>
            
            <!-- 时间范围 -->
            <if test="query.startTime != null">
                AND UNIX_TIMESTAMP(g.create_time) * 1000 >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND UNIX_TIMESTAMP(g.create_time) * 1000 &lt;= #{query.endTime}
            </if>
        </where>
        ORDER BY g.update_time DESC
        LIMIT #{query.size}
    </select>

</mapper>
